{% extends "base.html" %}

{% block title %}대시보드 - 메모장 + TODO 리스트{% endblock %}

{% block content %}
<div class="dashboard-main">
    <div class="dashboard-header">
        <h1><i class="fas fa-tachometer-alt"></i> 대시보드</h1>
        <div class="quick-actions">
            <button class="btn btn-success" onclick="openQuickMemoForm()">
                <i class="fas fa-plus"></i> 빠른 메모
            </button>
            <button class="btn btn-primary" onclick="openQuickTodoForm()">
                <i class="fas fa-plus"></i> 빠른 할 일
            </button>
        </div>
    </div>

    <div class="dashboard-content">
        <!-- 메모장 섹션 -->
        <div class="section memo-section">
            <div class="section-header">
                <h2><i class="fas fa-sticky-note"></i> 최근 메모</h2>
                <a href="/memos" class="btn btn-outline">모든 메모 보기</a>
            </div>
            <div class="memo-grid">
                {% for memo in recent_memos %}
                <div class="memo-box" onclick="openMemoEdit('{{ memo.id }}')">
                    <div class="memo-header">
                        <h3>{{ memo.title }}</h3>
                        <span class="memo-date">{{ memo.updated_at.strftime('%m/%d %H:%M') }}</span>
                    </div>
                    <div class="memo-content">
                        {{ memo.content[:100] }}{% if memo.content|length > 100 %}...{% endif %}
                    </div>
                    {% if memo.tags %}
                    <div class="memo-tags">
                        {% for tag in memo.tags %}
                        <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                
                {% if not recent_memos %}
                <div class="empty-state">
                    <i class="fas fa-sticky-note"></i>
                    <p>메모가 없습니다</p>
                    <button class="btn btn-success" onclick="openQuickMemoForm()">첫 메모 작성하기</button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- TODO 리스트 섹션 -->
        <div class="section todo-section">
            <div class="section-header">
                <h2><i class="fas fa-tasks"></i> 할 일 목록</h2>
                <a href="/todos" class="btn btn-outline">모든 할 일 보기</a>
            </div>
            <div class="todo-grid">
                {% for todo in pending_todos %}
                <div class="todo-box {{ 'overdue' if todo.is_overdue else '' }}" onclick="openTodoEdit('{{ todo.id }}')">
                    <div class="todo-checkbox-container">
                        <input type="checkbox" id="todo-dash-{{ todo.id }}" 
                               {{ 'checked' if todo.completed else '' }}
                               onclick="event.stopPropagation(); toggleTodoDash('{{ todo.id }}')"
                               class="todo-checkbox">
                        <label for="todo-dash-{{ todo.id }}" class="checkbox-label"></label>
                    </div>
                    <div class="todo-content">
                        <div class="todo-header">
                            <h3>{{ todo.title }}</h3>
                            <div class="todo-meta">
                                <span class="priority priority-{{ todo.priority }}">
                                    <i class="fas fa-flag"></i> {{ todo.priority }}
                                </span>
                                {% if todo.time_remaining %}
                                <span class="time-remaining {{ 'overdue' if todo.is_overdue else '' }}">
                                    <i class="fas fa-clock"></i> {{ todo.time_remaining }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% if todo.description %}
                        <p class="todo-description">{{ todo.description[:80] }}{% if todo.description|length > 80 %}...{% endif %}</p>
                        {% endif %}
                        {% if todo.due_date %}
                        <div class="todo-due">
                            <i class="fas fa-calendar"></i> {{ todo.due_date.strftime('%Y-%m-%d') }}
                            {% if todo.due_time %}
                            <i class="fas fa-clock"></i> {{ todo.due_time }}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                {% if not pending_todos %}
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <p>할 일이 없습니다</p>
                    <button class="btn btn-primary" onclick="openQuickTodoForm()">첫 할 일 추가하기</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 빠른 메모 추가 모달 -->
<div id="quickMemoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="memoModalTitle">빠른 메모 추가</h3>
            <button class="close-btn" onclick="closeQuickMemoForm()">&times;</button>
        </div>
        <form id="quickMemoForm">
            <input type="hidden" id="memoId" name="id">
            <div class="form-group">
                <label for="memoTitle">제목 *</label>
                <input type="text" id="memoTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="memoContent">내용 *</label>
                <textarea id="memoContent" name="content" rows="4" required></textarea>
            </div>
            <div class="form-group">
                <label for="memoTags">태그 (쉼표로 구분)</label>
                <input type="text" id="memoTags" name="tags" placeholder="태그1, 태그2, 태그3">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-success">저장</button>
                <button type="button" class="btn btn-secondary" onclick="closeQuickMemoForm()">취소</button>
            </div>
        </form>
    </div>
</div>

<!-- 빠른 할 일 추가 모달 -->
<div id="quickTodoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="todoModalTitle">빠른 할 일 추가</h3>
            <button class="close-btn" onclick="closeQuickTodoForm()">&times;</button>
        </div>
        <form id="quickTodoForm">
            <input type="hidden" id="todoId" name="id">
            <div class="form-group">
                <label for="todoTitle">할 일 *</label>
                <input type="text" id="todoTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="todoDescription">설명</label>
                <textarea id="todoDescription" name="description" rows="3"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="todoPriority">우선순위</label>
                    <select id="todoPriority" name="priority">
                        <option value="low">낮음</option>
                        <option value="medium" selected>보통</option>
                        <option value="high">높음</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="todoDueDate">마감일</label>
                    <input type="date" id="todoDueDate" name="due_date">
                </div>
            </div>
            <div class="form-group">
                <label for="todoDueTime">마감시간</label>
                <input type="time" id="todoDueTime" name="due_time">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">저장</button>
                <button type="button" class="btn btn-secondary" onclick="closeQuickTodoForm()">취소</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isMemoEditMode = false;
let isTodoEditMode = false;

// 빠른 메모 폼 열기
function openQuickMemoForm() {
    isMemoEditMode = false;
    document.getElementById('memoModalTitle').textContent = '빠른 메모 추가';
    document.getElementById('quickMemoForm').reset();
    document.getElementById('memoId').value = '';
    document.getElementById('quickMemoModal').style.display = 'block';
}

// 메모 편집 폼 열기
async function openMemoEdit(memoId) {
    isMemoEditMode = true;
    document.getElementById('memoModalTitle').textContent = '메모 편집';
    
    try {
        const response = await fetch(`/api/memos/${memoId}`);
        const memo = await response.json();
        
        document.getElementById('memoId').value = memo.id;
        document.getElementById('memoTitle').value = memo.title;
        document.getElementById('memoContent').value = memo.content;
        document.getElementById('memoTags').value = memo.tags ? memo.tags.join(', ') : '';
        
        document.getElementById('quickMemoModal').style.display = 'block';
    } catch (error) {
        alert('메모 정보를 불러오는데 실패했습니다.');
    }
}

// 빠른 메모 폼 닫기
function closeQuickMemoForm() {
    document.getElementById('quickMemoModal').style.display = 'none';
    document.getElementById('quickMemoForm').reset();
}

// 빠른 할 일 폼 열기
function openQuickTodoForm() {
    isTodoEditMode = false;
    document.getElementById('todoModalTitle').textContent = '빠른 할 일 추가';
    document.getElementById('quickTodoForm').reset();
    document.getElementById('todoId').value = '';
    document.getElementById('todoPriority').value = 'medium';
    document.getElementById('quickTodoModal').style.display = 'block';
}

// 할 일 편집 폼 열기
async function openTodoEdit(todoId) {
    isTodoEditMode = true;
    document.getElementById('todoModalTitle').textContent = '할 일 편집';
    
    try {
        const response = await fetch(`/api/todos/${todoId}`);
        const todo = await response.json();
        
        document.getElementById('todoId').value = todo.id;
        document.getElementById('todoTitle').value = todo.title;
        document.getElementById('todoDescription').value = todo.description || '';
        document.getElementById('todoPriority').value = todo.priority;
        document.getElementById('todoDueDate').value = todo.due_date || '';
        document.getElementById('todoDueTime').value = todo.due_time || '';
        
        document.getElementById('quickTodoModal').style.display = 'block';
    } catch (error) {
        alert('할 일 정보를 불러오는데 실패했습니다.');
    }
}

// 빠른 할 일 폼 닫기
function closeQuickTodoForm() {
    document.getElementById('quickTodoModal').style.display = 'none';
    document.getElementById('quickTodoForm').reset();
}

// 대시보드 TODO 완료 상태 토글
async function toggleTodoDash(todoId) {
    try {
        const response = await fetch(`/api/todos/${todoId}/toggle`, {
            method: 'PATCH'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('상태 변경에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
}

// 빠른 메모 폼 제출
document.getElementById('quickMemoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const tagsString = formData.get('tags');
    const tags = tagsString ? tagsString.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
    
    const memoData = {
        title: formData.get('title'),
        content: formData.get('content'),
        tags: tags
    };
    
    try {
        let response;
        if (isMemoEditMode) {
            const memoId = formData.get('id');
            response = await fetch(`/api/memos/${memoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memoData)
            });
        } else {
            response = await fetch('/api/memos/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memoData)
            });
        }
        
        if (response.ok) {
            closeQuickMemoForm();
            location.reload();
        } else {
            alert('저장에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
});

// 빠른 할 일 폼 제출
document.getElementById('quickTodoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const todoData = {
        title: formData.get('title'),
        description: formData.get('description'),
        priority: formData.get('priority'),
        due_date: formData.get('due_date') || null,
        due_time: formData.get('due_time') || null
    };
    
    try {
        let response;
        if (isTodoEditMode) {
            const todoId = formData.get('id');
            response = await fetch(`/api/todos/${todoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(todoData)
            });
        } else {
            response = await fetch('/api/todos/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(todoData)
            });
        }
        
        if (response.ok) {
            closeQuickTodoForm();
            location.reload();
        } else {
            alert('저장에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
});

// 모달 외부 클릭 시 닫기
window.onclick = function(event) {
    const memoModal = document.getElementById('quickMemoModal');
    const todoModal = document.getElementById('quickTodoModal');
    
    if (event.target === memoModal) {
        closeQuickMemoForm();
    }
    if (event.target === todoModal) {
        closeQuickTodoForm();
    }
}
</script>
{% endblock %}