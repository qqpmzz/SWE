{% extends "base.html" %}

{% block title %}TODO 리스트 - 메모장 + TODO 리스트{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2><i class="fas fa-tasks"></i> TODO 리스트</h2>
        <div class="page-actions">
            <button class="btn btn-success" onclick="openTodoForm()">
                <i class="fas fa-plus"></i> 새 할 일 추가
            </button>
        </div>
    </div>

    <!-- 필터 섹션 -->
    <div class="filter-section">
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterTodos('all')">전체</button>
            <button class="filter-btn" onclick="filterTodos('pending')">미완료</button>
            <button class="filter-btn" onclick="filterTodos('completed')">완료</button>
        </div>
        <div class="priority-filters">
            <select id="priorityFilter" onchange="filterByPriority()">
                <option value="">모든 우선순위</option>
                <option value="high">높음</option>
                <option value="medium">보통</option>
                <option value="low">낮음</option>
            </select>
        </div>
    </div>

    <!-- TODO 목록 -->
    <div class="todos-container" id="todosContainer">
        {% for todo in todos %}
        <div class="todo-item {{ 'completed' if todo.completed else '' }}" data-todo-id="{{ todo.id }}">
            <div class="todo-checkbox">
                <input type="checkbox" id="todo-{{ todo.id }}" 
                       {{ 'checked' if todo.completed else '' }}
                       onchange="toggleTodo('{{ todo.id }}')">
                <label for="todo-{{ todo.id }}"></label>
            </div>
            <div class="todo-content">
                <h3>{{ todo.title }}</h3>
                {% if todo.description %}
                    <p>{{ todo.description }}</p>
                {% endif %}
                <div class="todo-meta">
                    <span class="priority priority-{{ todo.priority }}">
                        <i class="fas fa-flag"></i> {{ todo.priority }}
                    </span>
                    {% if todo.due_date %}
                        <span class="due-date">
                            <i class="fas fa-calendar"></i> {{ todo.due_date }}
                        </span>
                    {% endif %}
                    <span class="created-date">
                        <i class="fas fa-clock"></i> {{ todo.created_at.strftime('%Y-%m-%d') }}
                    </span>
                </div>
            </div>
            <div class="todo-actions">
                <button class="btn-icon" onclick="editTodo('{{ todo.id }}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon" onclick="deleteTodo('{{ todo.id }}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not todos %}
    <div class="empty-state">
        <i class="fas fa-tasks"></i>
        <h3>할 일이 없습니다</h3>
        <p>첫 번째 할 일을 추가해보세요!</p>
        <button class="btn btn-success" onclick="openTodoForm()">
            <i class="fas fa-plus"></i> 할 일 추가하기
        </button>
    </div>
    {% endif %}
</div>

<!-- TODO 작성/편집 모달 -->
<div id="todoFormModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="todoModalTitle">새 할 일 추가</h3>
            <button class="close-btn" onclick="closeTodoForm()">&times;</button>
        </div>
        <form id="todoForm">
            <input type="hidden" id="todoId" name="id">
            <div class="form-group">
                <label for="todoTitle">할 일 *</label>
                <input type="text" id="todoTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="todoDescription">설명</label>
                <textarea id="todoDescription" name="description" rows="3"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="todoPriority">우선순위</label>
                    <select id="todoPriority" name="priority">
                        <option value="low">낮음</option>
                        <option value="medium" selected>보통</option>
                        <option value="high">높음</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="todoDueDate">마감일</label>
                    <input type="date" id="todoDueDate" name="due_date">
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-success">저장</button>
                <button type="button" class="btn btn-secondary" onclick="closeTodoForm()">취소</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isEditMode = false;

// TODO 폼 열기
function openTodoForm() {
    isEditMode = false;
    document.getElementById('todoModalTitle').textContent = '새 할 일 추가';
    document.getElementById('todoForm').reset();
    document.getElementById('todoId').value = '';
    document.getElementById('todoPriority').value = 'medium';
    document.getElementById('todoFormModal').style.display = 'block';
}

// TODO 편집 폼 열기
async function editTodo(todoId) {
    isEditMode = true;
    document.getElementById('todoModalTitle').textContent = '할 일 편집';
    
    try {
        const response = await fetch(`/api/todos/${todoId}`);
        const todo = await response.json();
        
        document.getElementById('todoId').value = todo.id;
        document.getElementById('todoTitle').value = todo.title;
        document.getElementById('todoDescription').value = todo.description || '';
        document.getElementById('todoPriority').value = todo.priority;
        document.getElementById('todoDueDate').value = todo.due_date || '';
        
        document.getElementById('todoFormModal').style.display = 'block';
    } catch (error) {
        alert('할 일 정보를 불러오는데 실패했습니다.');
    }
}

// TODO 폼 닫기
function closeTodoForm() {
    document.getElementById('todoFormModal').style.display = 'none';
    document.getElementById('todoForm').reset();
}

// TODO 완료 상태 토글
async function toggleTodo(todoId) {
    try {
        const response = await fetch(`/api/todos/${todoId}/toggle`, {
            method: 'PATCH'
        });
        
        if (response.ok) {
            const todo = await response.json();
            const todoItem = document.querySelector(`[data-todo-id="${todoId}"]`);
            
            if (todo.completed) {
                todoItem.classList.add('completed');
            } else {
                todoItem.classList.remove('completed');
            }
        } else {
            alert('상태 변경에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
}

// TODO 삭제
async function deleteTodo(todoId) {
    if (!confirm('이 할 일을 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/api/todos/${todoId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('삭제에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
}

// TODO 필터링
function filterTodos(status) {
    // 버튼 상태 업데이트
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    const todoItems = document.querySelectorAll('.todo-item');
    
    todoItems.forEach(item => {
        const isCompleted = item.classList.contains('completed');
        
        switch (status) {
            case 'all':
                item.style.display = 'flex';
                break;
            case 'completed':
                item.style.display = isCompleted ? 'flex' : 'none';
                break;
            case 'pending':
                item.style.display = !isCompleted ? 'flex' : 'none';
                break;
        }
    });
}

// 우선순위별 필터링
async function filterByPriority() {
    const priority = document.getElementById('priorityFilter').value;
    const container = document.getElementById('todosContainer');
    
    try {
        let url = '/api/todos/';
        if (priority) {
            url += `filter/?priority=${priority}`;
        }
        
        const response = await fetch(url);
        const todos = await response.json();
        
        container.innerHTML = '';
        
        if (todos.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-filter"></i>
                    <h3>해당 조건의 할 일이 없습니다</h3>
                </div>
            `;
            return;
        }
        
        todos.forEach(todo => {
            const todoItem = createTodoItem(todo);
            container.appendChild(todoItem);
        });
    } catch (error) {
        alert('필터링 중 오류가 발생했습니다.');
    }
}

// TODO 아이템 생성 함수
function createTodoItem(todo) {
    const div = document.createElement('div');
    div.className = `todo-item ${todo.completed ? 'completed' : ''}`;
    div.dataset.todoId = todo.id;
    
    const createdDate = new Date(todo.created_at).toLocaleDateString('ko-KR');
    const dueDateHtml = todo.due_date ? 
        `<span class="due-date"><i class="fas fa-calendar"></i> ${todo.due_date}</span>` : '';
    const descriptionHtml = todo.description ? `<p>${todo.description}</p>` : '';
    
    div.innerHTML = `
        <div class="todo-checkbox">
            <input type="checkbox" id="todo-${todo.id}" 
                   ${todo.completed ? 'checked' : ''}
                   onchange="toggleTodo('${todo.id}')">
            <label for="todo-${todo.id}"></label>
        </div>
        <div class="todo-content">
            <h3>${todo.title}</h3>
            ${descriptionHtml}
            <div class="todo-meta">
                <span class="priority priority-${todo.priority}">
                    <i class="fas fa-flag"></i> ${todo.priority}
                </span>
                ${dueDateHtml}
                <span class="created-date">
                    <i class="fas fa-clock"></i> ${createdDate}
                </span>
            </div>
        </div>
        <div class="todo-actions">
            <button class="btn-icon" onclick="editTodo('${todo.id}')">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon" onclick="deleteTodo('${todo.id}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    return div;
}

// TODO 폼 제출
document.getElementById('todoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const todoData = {
        title: formData.get('title'),
        description: formData.get('description'),
        priority: formData.get('priority'),
        due_date: formData.get('due_date') || null
    };
    
    try {
        let response;
        if (isEditMode) {
            const todoId = formData.get('id');
            response = await fetch(`/api/todos/${todoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(todoData)
            });
        } else {
            response = await fetch('/api/todos/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(todoData)
            });
        }
        
        if (response.ok) {
            closeTodoForm();
            location.reload();
        } else {
            alert('저장에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
});

// 모달 외부 클릭 시 닫기
window.onclick = function(event) {
    const modal = document.getElementById('todoFormModal');
    if (event.target === modal) {
        closeTodoForm();
    }
}
</script>
{% endblock %}