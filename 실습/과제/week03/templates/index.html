{% extends "base.html" %}

{% block title %}대시보드 - 메모장 + TODO 리스트{% endblock %}

{% block content %}
<div class="dashboard-main">
    <div class="dashboard-header">
        <h1><i class="fas fa-tachometer-alt"></i> 대시보드</h1>
    </div>

    <div class="dashboard-content">
        <!-- 메모장 섹션 -->
        <div class="section memo-section">
            <div class="section-header">
                <h2><i class="fas fa-sticky-note"></i> 메모장</h2>
                <button class="btn btn-success btn-sm" onclick="openQuickMemoForm()">
                    <i class="fas fa-plus"></i> 빠른 메모
                </button>
            </div>
            <div class="memo-grid">
                {% for memo in recent_memos %}
                <div class="memo-box" onclick="openMemoEdit('{{ memo.id }}')">
                    <div class="memo-header">
                        <h3>{{ memo.title }}</h3>
                        <span class="memo-date">{{ memo.updated_at.strftime('%m/%d %H:%M') }}</span>
                    </div>
                    <div class="memo-content">
                        {{ memo.content[:100] }}{% if memo.content|length > 100 %}...{% endif %}
                    </div>
                    {% if memo.tags %}
                    <div class="memo-tags">
                        {% for tag in memo.tags %}
                        <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                
                {% if not recent_memos %}
                <div class="empty-state">
                    <i class="fas fa-sticky-note"></i>
                    <p>메모가 없습니다</p>
                    <button class="btn btn-success" onclick="openQuickMemoForm()">첫 메모 작성하기</button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- TODO 리스트 섹션 -->
        <div class="section todo-section">
            <div class="section-header">
                <h2><i class="fas fa-tasks"></i> 할 일 목록</h2>
                <button class="btn btn-primary btn-sm" onclick="openQuickTodoForm()">
                    <i class="fas fa-plus"></i> 빠른 할 일
                </button>
            </div>
            <div class="todo-grid">
                {% for todo in pending_todos %}
                <div class="todo-box {{ 'overdue' if todo.is_overdue else '' }}" onclick="openTodoEdit('{{ todo.id }}')">
                    <div class="todo-checkbox-container">
                        <input type="checkbox" id="todo-dash-{{ todo.id }}" 
                               {{ 'checked' if todo.completed else '' }}
                               onclick="event.stopPropagation(); toggleTodoDash('{{ todo.id }}')"
                               class="todo-checkbox">
                        <label for="todo-dash-{{ todo.id }}" class="checkbox-label"></label>
                    </div>
                    <div class="todo-content">
                        <div class="todo-header">
                            <h3>{{ todo.title }}</h3>
                            <div class="todo-meta">
                                {% if todo.due_date or todo.due_time %}
                                <span class="time-remaining-live" 
                                      data-due-date="{{ todo.due_date if todo.due_date else '' }}"
                                      data-due-time="{{ todo.due_time if todo.due_time else '' }}">
                                    <i class="fas fa-clock"></i>
                                    <span class="countdown-text">계산 중...</span>
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% if todo.description %}
                        <p class="todo-description">{{ todo.description[:80] }}{% if todo.description|length > 80 %}...{% endif %}</p>
                        {% endif %}
                        {% if todo.due_date %}
                        <div class="todo-due">
                            <i class="fas fa-calendar"></i> {{ todo.due_date.strftime('%Y-%m-%d') }}
                            {% if todo.due_time %}
                            <i class="fas fa-clock"></i> {{ todo.due_time }}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                {% if not pending_todos %}
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <p>할 일이 없습니다</p>
                    <button class="btn btn-primary" onclick="openQuickTodoForm()">첫 할 일 추가하기</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 빠른 메모 추가 모달 -->
<div id="quickMemoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="memoModalTitle">빠른 메모 추가</h3>
            <button class="close-btn" onclick="closeQuickMemoForm()">&times;</button>
        </div>
        <form id="quickMemoForm">
            <input type="hidden" id="memoId" name="id">
            <div class="form-group">
                <label for="memoTitle">제목 *</label>
                <input type="text" id="memoTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="memoContent">내용 *</label>
                <textarea id="memoContent" name="content" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="memoTags">태그 (쉼표로 구분)</label>
                <input type="text" id="memoTags" name="tags" placeholder="태그1, 태그2, 태그3">
            </div>
        </form>
        <div class="form-actions">
            <button type="submit" form="quickMemoForm" class="btn btn-success">저장</button>
            <button type="button" class="btn btn-secondary" onclick="closeQuickMemoForm()">취소</button>
        </div>
    </div>
</div>

<!-- 빠른 할 일 추가 모달 -->
<div id="quickTodoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="todoModalTitle">빠른 할 일 추가</h3>
            <button class="close-btn" onclick="closeQuickTodoForm()">&times;</button>
        </div>
        <form id="quickTodoForm">
            <input type="hidden" id="todoId" name="id">
            <div class="form-group">
                <label for="todoTitle">할 일 *</label>
                <input type="text" id="todoTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="todoDescription">설명</label>
                <textarea id="todoDescription" name="description" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label for="todoDueDateTime">마감일시 (날짜 시간)</label>
                <div class="form-row">
                    <input type="date" id="todoDueDate" name="due_date" style="width: 50%;">
                    <input type="time" id="todoDueTime" name="due_time" style="width: 50%; margin-left: 10px;">
                </div>
            </div>
        </form>
        <div class="form-actions">
            <button type="submit" form="quickTodoForm" class="btn btn-primary">저장</button>
            <button type="button" class="btn btn-secondary" onclick="closeQuickTodoForm()">취소</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isMemoEditMode = false;
let isTodoEditMode = false;
let countdownInterval = null;

// 실시간 카운트다운 함수
function updateCountdowns() {
    const countdownElements = document.querySelectorAll('.time-remaining-live');
    const now = new Date();
    
    countdownElements.forEach(element => {
        const dueDate = element.dataset.dueDate;
        const dueTime = element.dataset.dueTime;
        const countdownText = element.querySelector('.countdown-text');
        
        if (!dueDate && !dueTime) {
            countdownText.textContent = '';
            element.style.display = 'none';
            return;
        }
        
        // 마감 시간 생성
        let dueDateTime;
        if (dueDate) {
            dueDateTime = new Date(dueDate);
            if (dueTime) {
                const [hours, minutes] = dueTime.split(':');
                dueDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            } else {
                dueDateTime.setHours(23, 59, 59, 999); // 날짜만 있으면 그날 끝으로 설정
            }
        } else if (dueTime) {
            // 오늘 날짜에 시간 설정
            dueDateTime = new Date();
            const [hours, minutes] = dueTime.split(':');
            dueDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            // 만약 이미 지났으면 내일로 설정
            if (dueDateTime <= now) {
                dueDateTime.setDate(dueDateTime.getDate() + 1);
            }
        }
        
        const timeDiff = dueDateTime - now;
        
        if (timeDiff <= 0) {
            // 시간이 지남 (연체)
            const overdueDiff = Math.abs(timeDiff);
            const overdueText = formatTimeDifference(overdueDiff);
            countdownText.textContent = `-${overdueText}`;
            element.classList.add('overdue');
        } else {
            // 남은 시간
            const remainingText = formatTimeDifference(timeDiff);
            countdownText.textContent = remainingText;
            element.classList.remove('overdue');
        }
        
        element.style.display = 'inline-block';
    });
}

// 시간 차이를 HH:MM:SS 형태로 포맷
function formatTimeDifference(timeDiff) {
    const totalSeconds = Math.floor(timeDiff / 1000);
    const totalMinutes = Math.floor(totalSeconds / 60);
    const totalHours = Math.floor(totalMinutes / 60);
    const totalDays = Math.floor(totalHours / 24);
    
    const days = totalDays;
    const hours = totalHours % 24;
    const minutes = totalMinutes % 60;
    const seconds = totalSeconds % 60;
    
    if (days > 0) {
        // 일이 있으면 일:시간:분 형태로 표시
        return `${days}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    } else {
        // 하루 이내면 시간:분:초 형태로 표시
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// 페이지 로드 시 카운트다운 시작
document.addEventListener('DOMContentLoaded', function() {
    updateCountdowns(); // 즉시 업데이트
    countdownInterval = setInterval(updateCountdowns, 1000); // 1초마다 업데이트
});

// 페이지를 떠날 때 인터벌 정리
window.addEventListener('beforeunload', function() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
});

// 빠른 메모 폼 열기
function openQuickMemoForm() {
    isMemoEditMode = false;
    document.getElementById('memoModalTitle').textContent = '빠른 메모 추가';
    document.getElementById('quickMemoForm').reset();
    document.getElementById('memoId').value = '';
    document.getElementById('quickMemoModal').style.display = 'block';
}

// 메모 편집 폼 열기
async function openMemoEdit(memoId) {
    isMemoEditMode = true;
    document.getElementById('memoModalTitle').textContent = '메모 편집';
    
    try {
        const response = await fetch(`/api/memos/${memoId}`);
        const memo = await response.json();
        
        document.getElementById('memoId').value = memo.id;
        document.getElementById('memoTitle').value = memo.title;
        document.getElementById('memoContent').value = memo.content;
        document.getElementById('memoTags').value = memo.tags ? memo.tags.join(', ') : '';
        
        document.getElementById('quickMemoModal').style.display = 'block';
    } catch (error) {
        alert('메모 정보를 불러오는데 실패했습니다.');
    }
}

// 빠른 메모 폼 닫기
function closeQuickMemoForm() {
    document.getElementById('quickMemoModal').style.display = 'none';
    document.getElementById('quickMemoForm').reset();
}

// 빠른 할 일 폼 열기
function openQuickTodoForm() {
    isTodoEditMode = false;
    document.getElementById('todoModalTitle').textContent = '빠른 할 일 추가';
    document.getElementById('quickTodoForm').reset();
    document.getElementById('todoId').value = '';
    document.getElementById('quickTodoModal').style.display = 'block';
}

// 할 일 편집 폼 열기
async function openTodoEdit(todoId) {
    isTodoEditMode = true;
    document.getElementById('todoModalTitle').textContent = '할 일 편집';
    
    try {
        const response = await fetch(`/api/todos/${todoId}`);
        const todo = await response.json();
        
        document.getElementById('todoId').value = todo.id;
        document.getElementById('todoTitle').value = todo.title;
        document.getElementById('todoDescription').value = todo.description || '';
        document.getElementById('todoDueDate').value = todo.due_date || '';
        document.getElementById('todoDueTime').value = todo.due_time || '';
        
        document.getElementById('quickTodoModal').style.display = 'block';
    } catch (error) {
        alert('할 일 정보를 불러오는데 실패했습니다.');
    }
}

// 빠른 할 일 폼 닫기
function closeQuickTodoForm() {
    document.getElementById('quickTodoModal').style.display = 'none';
    document.getElementById('quickTodoForm').reset();
}

// 대시보드 TODO 완료 상태 토글
async function toggleTodoDash(todoId) {
    try {
        const response = await fetch(`/api/todos/${todoId}/toggle`, {
            method: 'PATCH'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('상태 변경에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
}

// 빠른 메모 폼 제출
document.getElementById('quickMemoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const tagsString = formData.get('tags');
    const tags = tagsString ? tagsString.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
    
    const memoData = {
        title: formData.get('title'),
        content: formData.get('content'),
        tags: tags
    };
    
    try {
        let response;
        if (isMemoEditMode) {
            const memoId = formData.get('id');
            response = await fetch(`/api/memos/${memoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memoData)
            });
        } else {
            response = await fetch('/api/memos/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memoData)
            });
        }
        
        if (response.ok) {
            closeQuickMemoForm();
            location.reload();
        } else {
            alert('저장에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
});

// 빠른 할 일 폼 제출
document.getElementById('quickTodoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const todoData = {
        title: formData.get('title'),
        description: formData.get('description'),
        due_date: formData.get('due_date') || null,
        due_time: formData.get('due_time') || null
    };
    
    try {
        let response;
        if (isTodoEditMode) {
            const todoId = formData.get('id');
            response = await fetch(`/api/todos/${todoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(todoData)
            });
        } else {
            response = await fetch('/api/todos/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(todoData)
            });
        }
        
        if (response.ok) {
            closeQuickTodoForm();
            location.reload();
        } else {
            alert('저장에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
});

// 모달 외부 클릭 시 닫기
window.onclick = function(event) {
    const memoModal = document.getElementById('quickMemoModal');
    const todoModal = document.getElementById('quickTodoModal');
    
    if (event.target === memoModal) {
        closeQuickMemoForm();
    }
    if (event.target === todoModal) {
        closeQuickTodoForm();
    }
}
</script>
{% endblock %}