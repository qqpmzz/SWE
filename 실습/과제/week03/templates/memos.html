{% extends "base.html" %}

{% block title %}메모장 - 메모장 + TODO 리스트{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2><i class="fas fa-sticky-note"></i> 메모장</h2>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="openMemoForm()">
                <i class="fas fa-plus"></i> 새 메모 작성
            </button>
        </div>
    </div>

    <!-- 검색 바 -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="메모 검색..." onkeyup="searchMemos()">
            <i class="fas fa-search"></i>
        </div>
    </div>

    <!-- 메모 목록 -->
    <div class="memos-grid" id="memosContainer">
        {% for memo in memos %}
        <div class="memo-card" data-memo-id="{{ memo.id }}">
            <div class="memo-header">
                <h3>{{ memo.title }}</h3>
                <div class="memo-actions">
                    <button class="btn-icon" onclick="editMemo('{{ memo.id }}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteMemo('{{ memo.id }}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="memo-content">
                <p>{{ memo.content }}</p>
            </div>
            <div class="memo-footer">
                <div class="memo-tags">
                    {% for tag in memo.tags %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                <div class="memo-meta">
                    <small><i class="fas fa-clock"></i> {{ memo.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not memos %}
    <div class="empty-state">
        <i class="fas fa-sticky-note"></i>
        <h3>아직 작성된 메모가 없습니다</h3>
        <p>첫 번째 메모를 작성해보세요!</p>
        <button class="btn btn-primary" onclick="openMemoForm()">
            <i class="fas fa-plus"></i> 메모 작성하기
        </button>
    </div>
    {% endif %}
</div>

<!-- 메모 작성/편집 모달 -->
<div id="memoFormModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 id="modalTitle">새 메모 작성</h3>
            <button class="close-btn" onclick="closeMemoForm()">&times;</button>
        </div>
        <form id="memoForm">
            <input type="hidden" id="memoId" name="id">
            <div class="form-group">
                <label for="title">제목 *</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="content">내용 *</label>
                <textarea id="content" name="content" rows="10" required></textarea>
            </div>
            <div class="form-group">
                <label for="tags">태그 (쉼표로 구분)</label>
                <input type="text" id="tags" name="tags" placeholder="예: 업무, 개인, 중요">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">저장</button>
                <button type="button" class="btn btn-secondary" onclick="closeMemoForm()">취소</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isEditMode = false;

// 메모 작성 폼 열기
function openMemoForm() {
    isEditMode = false;
    document.getElementById('modalTitle').textContent = '새 메모 작성';
    document.getElementById('memoForm').reset();
    document.getElementById('memoId').value = '';
    document.getElementById('memoFormModal').style.display = 'block';
}

// 메모 편집 폼 열기
async function editMemo(memoId) {
    isEditMode = true;
    document.getElementById('modalTitle').textContent = '메모 편집';
    
    try {
        const response = await fetch(`/api/memos/${memoId}`);
        const memo = await response.json();
        
        document.getElementById('memoId').value = memo.id;
        document.getElementById('title').value = memo.title;
        document.getElementById('content').value = memo.content;
        document.getElementById('tags').value = memo.tags.join(', ');
        
        document.getElementById('memoFormModal').style.display = 'block';
    } catch (error) {
        alert('메모 정보를 불러오는데 실패했습니다.');
    }
}

// 메모 폼 닫기
function closeMemoForm() {
    document.getElementById('memoFormModal').style.display = 'none';
    document.getElementById('memoForm').reset();
}

// 메모 삭제
async function deleteMemo(memoId) {
    if (!confirm('이 메모를 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/api/memos/${memoId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('메모 삭제에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
}

// 메모 검색
async function searchMemos() {
    const query = document.getElementById('searchInput').value;
    const container = document.getElementById('memosContainer');
    
    if (!query.trim()) {
        location.reload();
        return;
    }
    
    try {
        const response = await fetch(`/api/memos/search/?q=${encodeURIComponent(query)}`);
        const memos = await response.json();
        
        container.innerHTML = '';
        
        if (memos.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h3>검색 결과가 없습니다</h3>
                    <p>"${query}"와 일치하는 메모를 찾을 수 없습니다.</p>
                </div>
            `;
            return;
        }
        
        memos.forEach(memo => {
            const memoCard = createMemoCard(memo);
            container.appendChild(memoCard);
        });
    } catch (error) {
        alert('검색 중 오류가 발생했습니다.');
    }
}

// 메모 카드 생성 함수
function createMemoCard(memo) {
    const div = document.createElement('div');
    div.className = 'memo-card';
    div.dataset.memoId = memo.id;
    
    const createdAt = new Date(memo.updated_at).toLocaleString('ko-KR');
    const tagsHtml = memo.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
    
    div.innerHTML = `
        <div class="memo-header">
            <h3>${memo.title}</h3>
            <div class="memo-actions">
                <button class="btn-icon" onclick="editMemo('${memo.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon" onclick="deleteMemo('${memo.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="memo-content">
            <p>${memo.content}</p>
        </div>
        <div class="memo-footer">
            <div class="memo-tags">${tagsHtml}</div>
            <div class="memo-meta">
                <small><i class="fas fa-clock"></i> ${createdAt}</small>
            </div>
        </div>
    `;
    
    return div;
}

// 메모 폼 제출
document.getElementById('memoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const tags = formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag);
    
    const memoData = {
        title: formData.get('title'),
        content: formData.get('content'),
        tags: tags
    };
    
    try {
        let response;
        if (isEditMode) {
            const memoId = formData.get('id');
            response = await fetch(`/api/memos/${memoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memoData)
            });
        } else {
            response = await fetch('/api/memos/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memoData)
            });
        }
        
        if (response.ok) {
            closeMemoForm();
            location.reload();
        } else {
            alert('메모 저장에 실패했습니다.');
        }
    } catch (error) {
        alert('오류가 발생했습니다.');
    }
});

// 모달 외부 클릭 시 닫기
window.onclick = function(event) {
    const modal = document.getElementById('memoFormModal');
    if (event.target === modal) {
        closeMemoForm();
    }
}
</script>
{% endblock %}